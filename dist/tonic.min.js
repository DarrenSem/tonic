class Tonic extends window.HTMLElement{constructor(){super();const state=Tonic._states[this.id];delete Tonic._states[this.id],this.isTonicComponent=!0,this.state=state||{},this.props={},this.elements=[...this.children].map(el=>el.cloneNode(!0)),this.elements.__children__=!0,this.nodes=[...this.childNodes].map(el=>el.cloneNode(!0)),this.nodes.__children__=!0,this._events()}static _createId(){return`tonic${Tonic._index++}`}static _maybePromise(p){p&&"function"==typeof p.then&&"function"==typeof p.catch&&p.catch(err=>setTimeout(()=>{throw err},0))}static _splitName(s){return s.match(/[A-Z][a-z]*/g).join("-")}static _normalizeAttrs(o,x={}){return[...o].forEach(o=>x[o.name]=o.value),x}_events(){const hp=Object.getOwnPropertyNames(window.HTMLElement.prototype);for(const p of this._props)-1!==hp.indexOf("on"+p)&&this.addEventListener(p,this)}_prop(o){const id=this._id,p=`__${id}__${Tonic._createId()}__`;return Tonic._data[id]=Tonic._data[id]||{},Tonic._data[id][p]=o,p}_placehold(r){const ref=`__${Tonic._createId()}__`;return Tonic._children[this._id]=Tonic._children[this._id]||{},Tonic._children[this._id][ref]=r,ref}static match(el,s){return el.matches||(el=el.parentElement),el.matches(s)?el:el.closest(s)}static getPropertyNames(proto){const props=[];while(proto&&proto!==Tonic.prototype)props.push(...Object.getOwnPropertyNames(proto)),proto=Object.getPrototypeOf(proto);return props}static add(c,htmlName){if(c.prototype._props=Tonic.getPropertyNames(c.prototype),!(htmlName||c.name&&c.name.length>1))throw Error("Mangling. https://bit.ly/2TkJ6zP");htmlName||(htmlName=Tonic._splitName(c.name).toLowerCase()),window.customElements.get(htmlName)||(Tonic._reg[htmlName]=c,Tonic._tags=Object.keys(Tonic._reg).join(),window.customElements.define(htmlName,c))}static sanitize(o){if(!o)return o;for(const[k,v]of Object.entries(o))"[object HTMLElement]"!==Object.prototype.toString.call(v)&&("object"==typeof v&&(o[k]=Tonic.sanitize(v)),"string"==typeof v&&(o[k]=Tonic.escape(v)));return o}static escape(s){return s.replace(Tonic.ESC,c=>Tonic.MAP[c])}html([s,...strings],...values){return values.map(o=>{if(o&&o.__children__)return this._placehold(o);switch(Object.prototype.toString.call(o)){case"[object HTMLCollection]":case"[object NodeList]":return this._placehold([...o]);case"[object Array]":case"[object Object]":case"[object Function]":return this._prop(o);case"[object NamedNodeMap]":return this._prop(Tonic._normalizeAttrs(o));case"[object Number]":return`${o}__float`;case"[object Boolean]":return`${o}__boolean`;case"[object HTMLElement]":return o.isTonicComponent?this._prop(o):o}return o}).reduce((a,b)=>a.concat(b,strings.shift()),[s]).join("")}setState(o){this.state="function"==typeof o?o(this.state):o}getState(){return this.state}scheduleReRender(oldProps){return this.pendingReRender?this.pendingReRender:(this.pendingReRender=new Promise(resolve=>{window.requestAnimationFrame(()=>{Tonic._maybePromise(this._set(this.root,this.render)),this.pendingReRender=null,this.updated&&this.updated(oldProps),resolve()})}),this.pendingReRender)}reRender(o=this.props){const oldProps={...this.props};return this.props=Tonic.sanitize("function"==typeof o?o(this.props):o),this.scheduleReRender(oldProps)}getProps(){return this.props}handleEvent(e){const p=this[e.type](e);Tonic._maybePromise(p)}async _set(target,render,content=""){for(const node of target.querySelectorAll(Tonic._tags))node.isTonicComponent&&node.id&&Tonic._refIds.includes(node.id)&&(Tonic._states[node.id]=node.getState());if(render instanceof Tonic.AsyncFunction)content=await render.call(this)||"";else{if(render instanceof Tonic.AsyncFunctionGenerator){const itr=render.call(this);while(1){const{value:value,done:done}=await itr.next();if(this._set(target,null,value),done)break}return}render instanceof Function&&(content=render.call(this)||"")}if("string"==typeof content){if(content=content.replace(Tonic.SPREAD,(_,p)=>{const o=Tonic._data[p.split("__")[1]][p];return Object.entries(o).map(([key,value])=>{return`${key.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}="${Tonic.escape(String(value))}"`}).join(" ")}),target.innerHTML=content,this.styles){const styles=this.styles();for(const node of target.querySelectorAll("[styles]"))for(const s of node.getAttribute("styles").split(/\s+/))Object.assign(node.style,styles[s.trim()])}const children=Tonic._children[this._id]||{},walk=(node,fn)=>{if(3===node.nodeType){const id=node.textContent.trim();if(children[id])return fn(node,children[id])}node=node.firstChild;while(node)walk(node,fn),node=node.nextSibling};walk(target,(node,children)=>{for(const child of children)node.parentNode.appendChild(child);delete Tonic._children[this._id][node.id],node.parentNode.removeChild(node)})}else target.innerHTML="",target.appendChild(content.cloneNode(!0));if(this.stylesheet){const styleNode=document.createElement("style");styleNode.appendChild(document.createTextNode(this.stylesheet())),target.insertBefore(styleNode,target.firstChild)}}connectedCallback(){this.root=this.shadowRoot||this,this.wrap&&(this.wrapped=this.render,this.render=this.wrap),this.id&&!Tonic._refIds.includes(this.id)&&Tonic._refIds.push(this.id);const cc=s=>s.replace(/-(.)/g,(_,m)=>m.toUpperCase());for(const{name:_name,value:value}of this.attributes){const name=cc(_name),p=this.props[name]=value;if(/__\w+__\w+__/.test(p)){const{1:root}=p.split("__");this.props[name]=Tonic._data[root][p]}else/\d+__float/.test(p)?this.props[name]=parseFloat(p,10):/\w+__boolean/.test(p)&&(this.props[name]=p.includes("true"))}this.props=Object.assign(this.defaults&&this.defaults()||{},Tonic.sanitize(this.props)),this._source?this.innerHTML=this._source:this._source=this.innerHTML,this._id=this._id||Tonic._createId(),this.willConnect&&this.willConnect(),Tonic._maybePromise(this._set(this.root,this.render)),Tonic._maybePromise(this.connected&&this.connected())}disconnectedCallback(){Tonic._maybePromise(this.disconnected&&this.disconnected()),this.elements.length=0,this.nodes.length=0,delete Tonic._data[this._id],delete Tonic._children[this._id]}}Object.assign(Tonic,{_tags:"",_refIds:[],_data:{},_states:{},_children:{},_reg:{},_index:0,SPREAD:/\.\.\.(__\w+__\w+__)/g,ESC:/["&'<>`]/g,AsyncFunctionGenerator:async function*(){}.constructor,AsyncFunction:async function(){}.constructor,MAP:{'"':"&quot;","&":"&amp;","'":"&#x27;","<":"&lt;",">":"&gt;","`":"&#x60;"}}),"object"==typeof module&&(module.exports=Tonic);