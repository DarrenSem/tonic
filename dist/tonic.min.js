class Tonic{constructor({node:node,state:state}={}){this.props={},this.state=state||{};const name=Tonic._splitName(this.constructor.name),r=this.root=node||document.createElement(name);if(r._id=Tonic._createId(),r._unmount=(index=>this._unmount(index)),r.reRender=(v=>this.reRender(v)),r.setState=(v=>this.setState(v)),r.getProps=(()=>this.getProps()),r.getState=(()=>this.getState()),this._events(),this.wrap){const render=this.render;this.render=(()=>this.wrap(render.bind(this)))}this._connect(),Tonic._refs.push(this.root)}static _createId(){return Math.random().toString(16).slice(2,8)}static match(el,s){return el.matches||(el=el.parentElement),el.matches(s)?el:el.closest(s)}static add(c,root){if(c.prototype._props=Object.getOwnPropertyNames(c.prototype),!c.name||1===c.name.length)throw Error("Mangling. https://bit.ly/2TkJ6zP");const d=document,name=Tonic._splitName(c.name);if(Tonic._reg[name.toUpperCase()]=c,Tonic._tags=Object.keys(Tonic._reg),!c.registered){if(c.registered=!0,!Tonic.styleNode){const t=d.createElement("style");Tonic.nonce&&t.setAttribute("nonce",Tonic.nonce),Tonic.styleNode=d.head.appendChild(t)}(root||"App"===c.name)&&Tonic.init(root||d.firstElementChild)}}static init(node=document.firstElementChild,states={}){node=node.firstElementChild;while(node){const t=node.tagName;!Tonic._tags.includes(t)||node._id?(Tonic.init(node,states),node=node.nextElementSibling):(new Tonic._reg[t]({node:node,state:states[node.id]}),node=node.nextElementSibling)}}static sanitize(o){if(null===o)return o;for(const[k,v]of Object.entries(o))"object"==typeof v&&(o[k]=Tonic.sanitize(v)),"string"==typeof v&&(o[k]=Tonic.escape(v));return o}static escape(s){return s.replace(Tonic.escapeRe,ch=>Tonic.escapeMap[ch])}static _splitName(s){return s.match(/[A-Z][a-z]*/g).join("-")}html([s,...strings],...values){return values.map(v=>{const isObject="object"==typeof v;return isObject&&v.__children__?this._children(v):isObject||"function"==typeof v?this._prop(v):"number"==typeof v?`${v}__float`:"boolean"==typeof v?`${v.toString()}`:v}).reduce((a,b)=>a.concat(b,strings.shift()),[s]).filter(s=>s&&(!0!==s||0===s)).join("")}setState(o){this.state="function"==typeof o?o(this.state):o}getState(){return this.state}reRender(o=this.props){if(!this.root)return;const oldProps=JSON.parse(JSON.stringify(this.props));this.props=Tonic.sanitize("function"==typeof o?o(this.props):o),Tonic.init(this.root,this._set(this.root,this.render())),this.updated&&this.updated(oldProps)}getProps(){return this.props}handleEvent(e){this[e.type](e)}_events(){const hp=Object.getOwnPropertyNames(window.HTMLElement.prototype);for(const p of this._props)-1!==hp.indexOf("on"+p)&&this.root.addEventListener(p,this)}_set(target,content=""){const states={};if(target.querySelectorAll(Tonic._tags.join()).forEach(node=>{const index=Tonic._refs.findIndex(ref=>ref===node);-1!==index&&(states[node.id]=node.getState(),node._unmount(index))}),"string"==typeof content){if(target.innerHTML=content.trim(),this.styles){const styles=this.styles();target.querySelectorAll("[styles]").forEach(el=>el.getAttribute("styles").split(/\s+/).forEach(s=>Object.assign(el.style,styles[s.trim()])))}target.querySelectorAll("tonic-children").forEach(el=>{const root=Tonic._elements[this.root._id];root[el.id].forEach(node=>{el.parentNode.insertBefore(node,el)}),delete root[el.id],el.parentNode.removeChild(el)})}else target.innerHTML="",target.appendChild(content.cloneNode(!0));return this.root=target,states}_prop(o){const id=this.root._id,p=`__${id}__${Tonic._createId()}__`;return Tonic._data[id]||(Tonic._data[id]={}),Tonic._data[id][p]=o,p}_children(r){const id=this.root._id,ref=Tonic._createId();return Tonic._elements[id]||(Tonic._elements[id]={}),Tonic._elements[id][ref]=r,`<tonic-children id="${ref}"/></tonic-children>`}_connect(){for(let{name:name,value:value}of this.root.attributes){name=name.replace(/-(.)/g,(_,m)=>m.toUpperCase());const p=this.props[name]=value;if(/__\w+__\w+__/.test(p)){const{1:root}=p.split("__");this.props[name]=Tonic._data[root][p]}else/\d+__float/.test(p)&&(this.props[name]=parseFloat(p,10))}const defaults=this.defaults&&this.defaults();this.props=Object.assign(Tonic.sanitize(this.props),defaults),this.willConnect&&this.willConnect(),this.children=[...this.root.childNodes].map(node=>node.cloneNode(!0)),this.children.__children__=!0,this._set(this.root,this.render()),Tonic.init(this.root),this.stylesheet&&!Tonic._reg[this.root.tagName].styled&&(Tonic._reg[this.root.tagName].styled=!0,Tonic.styleNode.appendChild(document.createTextNode(this.stylesheet()))),this.connected&&this.connected()}_unmount(index){this.disconnected&&this.disconnected(),delete Tonic._data[this.root._id],delete Tonic._elements[this.root._id],delete this.root,Tonic._refs.splice(index,1)}}Tonic.render=Tonic.add,Object.assign(Tonic,{_tags:[],_refs:[],_data:{},_elements:{},_reg:{},escapeRe:/["&'<>`]/g,escapeMap:{'"':"&quot;","&":"&amp;","'":"&#x27;","<":"&lt;",">":"&gt;","`":"&#x60;"}}),"object"==typeof module&&(module.exports=Tonic);